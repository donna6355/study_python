-- PostgreSQL DDL Conversion

-- Drop tables (CASCADE removes dependencies)
DROP TABLE IF EXISTS DEPT CASCADE;
DROP TABLE IF EXISTS EMP CASCADE;
DROP TABLE IF EXISTS LG_MEMBER CASCADE;
DROP TABLE IF EXISTS LG_PRODUCT CASCADE;
DROP TABLE IF EXISTS PRODUCT_REVIEW CASCADE;
DROP TABLE IF EXISTS MEMBER_PURCHASE CASCADE;
DROP TABLE IF EXISTS AS_REQUEST CASCADE;

-- EMP table
CREATE TABLE EMP (
  EMP_ID        VARCHAR(20) PRIMARY KEY,
  NAME          VARCHAR(50) NOT NULL,
  GENDER        VARCHAR(10) NOT NULL,
  BIRTH_DATE    VARCHAR(8) NOT NULL,
  HIRE_DATE     VARCHAR(8),
  JOB_TITLE     VARCHAR(50),
  JOB_LEVEL     VARCHAR(10),
  DEPT_NO       VARCHAR(10),
  LEAVE_AMOUNT  NUMERIC(3),
  RETIRE_YN     CHAR(1),
  RETIRE_DATE   DATE,
  CREATED_AT    TIMESTAMP
);

COMMENT ON COLUMN EMP.EMP_ID IS '사번 (고유값)';
COMMENT ON COLUMN EMP.NAME IS '이름';
COMMENT ON COLUMN EMP.GENDER IS '성별';
COMMENT ON COLUMN EMP.BIRTH_DATE IS '생년월일(YYYYMMDD)';
COMMENT ON COLUMN EMP.HIRE_DATE IS '입사일';
COMMENT ON COLUMN EMP.JOB_TITLE IS '직책 (선임, 책임, 수석, 팀장 등)';
COMMENT ON COLUMN EMP.JOB_LEVEL IS '직급 등급 (P1, P2, P3 등)';
COMMENT ON COLUMN EMP.DEPT_NO IS '소속 부서 (외래키)';
COMMENT ON COLUMN EMP.LEAVE_AMOUNT IS '보유연차수';
COMMENT ON COLUMN EMP.RETIRE_YN IS '퇴직여부 (Y/N)';
COMMENT ON COLUMN EMP.RETIRE_DATE IS '퇴직일자';
COMMENT ON COLUMN EMP.CREATED_AT IS '생성일시';

-- DEPT table
CREATE TABLE DEPT (
  DEPT_NO        VARCHAR(10) PRIMARY KEY,
  DEPT_NAME      VARCHAR(100),
  DEPT_EN_NAME   VARCHAR(100),
  LOCATION       VARCHAR(100),
  CREATED_AT     TIMESTAMP
);

COMMENT ON COLUMN DEPT.DEPT_NO IS '부서번호 (고유값)';
COMMENT ON COLUMN DEPT.DEPT_NAME IS '부서명';
COMMENT ON COLUMN DEPT.DEPT_EN_NAME IS '부서 영어명';
COMMENT ON COLUMN DEPT.LOCATION IS '부서 위치';
COMMENT ON COLUMN DEPT.CREATED_AT IS '생성일시';

-- LG_MEMBER table
CREATE TABLE LG_MEMBER (
  MEMBER_ID     VARCHAR(30) PRIMARY KEY,
  PASSWD        VARCHAR(255) NOT NULL,
  MEMBER_NAME   VARCHAR(100) NOT NULL,
  EMAIL         VARCHAR(150) NOT NULL,
  PHONE_NUMBER  VARCHAR(20),
  ADDRESS       VARCHAR(300),
  JOIN_DATE     TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  STATUS        VARCHAR(20) DEFAULT 'ACTIVE',
  CREATED_AT    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

ALTER TABLE LG_MEMBER
  ADD CONSTRAINT UQ_LG_MEMBER_EMAIL UNIQUE (EMAIL);

COMMENT ON COLUMN LG_MEMBER.MEMBER_ID IS '서비스 사용자 ID (고유값)';
COMMENT ON COLUMN LG_MEMBER.PASSWD IS '사용자 패스워드';
COMMENT ON COLUMN LG_MEMBER.MEMBER_NAME IS '사용자 이름';
COMMENT ON COLUMN LG_MEMBER.EMAIL IS '이메일 (로그인 계정, UNIQUE)';
COMMENT ON COLUMN LG_MEMBER.PHONE_NUMBER IS '연락처';
COMMENT ON COLUMN LG_MEMBER.ADDRESS IS '주소';
COMMENT ON COLUMN LG_MEMBER.JOIN_DATE IS '가입일';
COMMENT ON COLUMN LG_MEMBER.STATUS IS '사용자 상태 (ACTIVE/SUSPENDED 등)';
COMMENT ON COLUMN LG_MEMBER.CREATED_AT IS '생성 일시';

-- LG_PRODUCT table
CREATE TABLE LG_PRODUCT (
  PRODUCT_ID    SERIAL PRIMARY KEY,
  PRODUCT_NAME  VARCHAR(200) NOT NULL,
  CATEGORY      VARCHAR(100),
  PRICE         NUMERIC(12,0),
  STOCK_QTY     NUMERIC DEFAULT 0,
  CREATED_AT    TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON COLUMN LG_PRODUCT.PRODUCT_ID IS '상품 ID (고유값)';
COMMENT ON COLUMN LG_PRODUCT.PRODUCT_NAME IS '상품명';
COMMENT ON COLUMN LG_PRODUCT.CATEGORY IS '상품 카테고리';
COMMENT ON COLUMN LG_PRODUCT.PRICE IS '가격';
COMMENT ON COLUMN LG_PRODUCT.STOCK_QTY IS '재고 수량';
COMMENT ON COLUMN LG_PRODUCT.CREATED_AT IS '등록 일시';

-- PRODUCT_REVIEW table
CREATE TABLE PRODUCT_REVIEW (
  REVIEW_ID    SERIAL PRIMARY KEY,
  PRODUCT_ID   INTEGER NOT NULL,
  RATING       NUMERIC(1) NOT NULL CHECK (RATING BETWEEN 1 AND 5),
  REVIEW_TEXT  TEXT,
  CREATED_AT   TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON COLUMN PRODUCT_REVIEW.REVIEW_ID IS '리뷰 ID (고유값)';
COMMENT ON COLUMN PRODUCT_REVIEW.PRODUCT_ID IS '상품 ID (외래키)';
COMMENT ON COLUMN PRODUCT_REVIEW.RATING IS '평점 (1~5점)';
COMMENT ON COLUMN PRODUCT_REVIEW.REVIEW_TEXT IS '리뷰 내용';
COMMENT ON COLUMN PRODUCT_REVIEW.CREATED_AT IS '작성 일시';

-- MEMBER_PURCHASE table
CREATE TABLE MEMBER_PURCHASE (
  PURCHASE_ID   SERIAL PRIMARY KEY,
  MEMBER_ID     VARCHAR(30) NOT NULL,
  PRODUCT_ID    INTEGER NOT NULL,
  QUANTITY      NUMERIC DEFAULT 1 NOT NULL,
  TOTAL_PRICE   NUMERIC(12,0),
  PURCHASE_DATE TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON COLUMN MEMBER_PURCHASE.PURCHASE_ID IS '구매 ID (고유값)';
COMMENT ON COLUMN MEMBER_PURCHASE.MEMBER_ID IS '구매자 (외래키)';
COMMENT ON COLUMN MEMBER_PURCHASE.PRODUCT_ID IS '구매 상품 (외래키)';
COMMENT ON COLUMN MEMBER_PURCHASE.QUANTITY IS '구매 수량';
COMMENT ON COLUMN MEMBER_PURCHASE.TOTAL_PRICE IS '총 결제 금액';
COMMENT ON COLUMN MEMBER_PURCHASE.PURCHASE_DATE IS '구매 일시';

-- AS_REQUEST table
CREATE TABLE AS_REQUEST (
  REQUEST_ID    SERIAL PRIMARY KEY,
  PURCHASE_ID   INTEGER NOT NULL,
  REQUEST_DATE  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  STATUS        VARCHAR(20) DEFAULT 'REQUESTED',
  DESCRIPTION   TEXT,
  COMPLETED_AT  TIMESTAMP
);

COMMENT ON COLUMN AS_REQUEST.REQUEST_ID IS 'AS 요청 ID (고유값)';
COMMENT ON COLUMN AS_REQUEST.PURCHASE_ID IS '구매 ID (외래키)';
COMMENT ON COLUMN AS_REQUEST.REQUEST_DATE IS 'AS 요청 일자';
COMMENT ON COLUMN AS_REQUEST.STATUS IS 'AS 상태 (REQUESTED/IN_PROGRESS/DONE 등)';
COMMENT ON COLUMN AS_REQUEST.DESCRIPTION IS 'AS 요청 상세 내용';
COMMENT ON COLUMN AS_REQUEST.COMPLETED_AT IS 'AS 완료 일시';

-- Drop additional tables
DROP TABLE IF EXISTS DB_PROBLEM_TAG CASCADE;
DROP TABLE IF EXISTS DB_TAG CASCADE;
DROP TABLE IF EXISTS USER_PROBLEM_ACCESS CASCADE;
DROP TABLE IF EXISTS USER_PROBLEM_ATTEMPT CASCADE;
DROP TABLE IF EXISTS APP_USER CASCADE;
DROP TABLE IF EXISTS DB_PROBLEM CASCADE;
DROP TABLE IF EXISTS USER_PROBLEM CASCADE;

-- APP_USER table
CREATE TABLE APP_USER (
  USER_ID         VARCHAR(50) PRIMARY KEY,
  PASSWORD_PLAIN  VARCHAR(200) NOT NULL,
  ROLE            VARCHAR(20) DEFAULT 'STUDENT' NOT NULL,
  CREATED_AT      TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

-- DB_PROBLEM table
CREATE TABLE DB_PROBLEM (
  PROBLEM_ID                SERIAL PRIMARY KEY,
  TITLE                     VARCHAR(200) NOT NULL,
  DESCRIPTION               TEXT NOT NULL,
  EXPECTED_SQL              TEXT NOT NULL,
  DIFFICULTY                VARCHAR(20),
  IS_ACTIVE                 CHAR(1) DEFAULT 'Y' CHECK (IS_ACTIVE IN ('Y','N')),
  EXPECTED_COLS             VARCHAR(1000),
  REQUIRE_ORDER_BY          CHAR(1) DEFAULT 'N' CHECK (REQUIRE_ORDER_BY IN ('Y','N')),
  REQUIRE_ORDERED_RESULT    CHAR(1) DEFAULT 'N' CHECK (REQUIRE_ORDERED_RESULT IN ('Y','N')),
  REQUIRE_EXACT_COLNAMES    CHAR(1) DEFAULT 'N' CHECK (REQUIRE_EXACT_COLNAMES IN ('Y','N')),
  REQUIRE_EXACT_TYPES       CHAR(1) DEFAULT 'N' CHECK (REQUIRE_EXACT_TYPES IN ('Y','N')),
  CREATED_BY                VARCHAR(50),
  CREATED_AT                TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

-- USER_PROBLEM table
CREATE TABLE USER_PROBLEM (
  USER_ID            VARCHAR(50) NOT NULL,
  PROBLEM_ID         INTEGER NOT NULL,
  FIRST_ACCESSED_AT  TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
  STARTED_AT         TIMESTAMP NULL,
  SOLVED_AT          TIMESTAMP NULL,
  ATTEMPTS           INTEGER DEFAULT 0 NOT NULL,
  FAILURES           INTEGER DEFAULT 0 NOT NULL,
  SUCCESSES          INTEGER DEFAULT 0 NOT NULL,
  BEST_SCORE         NUMERIC DEFAULT 0 NOT NULL,
  LAST_SCORE         NUMERIC DEFAULT 100 NOT NULL,
  LAST_ATTEMPT_AT    TIMESTAMP NULL,
  CONSTRAINT PK_USER_PROBLEM PRIMARY KEY (USER_ID, PROBLEM_ID)
);

-- USER_PROBLEM_ACCESS table
CREATE TABLE USER_PROBLEM_ACCESS (
  ACCESS_ID    SERIAL PRIMARY KEY,
  USER_ID      VARCHAR(50) NOT NULL,
  PROBLEM_ID   INTEGER NOT NULL,
  ACCESSED_AT  TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

-- USER_PROBLEM_ATTEMPT table
CREATE TABLE USER_PROBLEM_ATTEMPT (
  ATTEMPT_ID      SERIAL PRIMARY KEY,
  USER_ID         VARCHAR(50) NOT NULL,
  PROBLEM_ID      INTEGER NOT NULL,
  ATTEMPT_NO      INTEGER NOT NULL,
  SUBMITTED_SQL   TEXT NOT NULL,
  IS_CORRECT      CHAR(1) NOT NULL CHECK (IS_CORRECT IN ('Y','N')),
  SCORE_AFTER     NUMERIC NOT NULL,
  ERROR_MESSAGE   VARCHAR(4000),
  EXEC_MS         NUMERIC,
  SUBMITTED_AT    TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

-- DB_TAG table
CREATE TABLE DB_TAG (
  TAG_ID    SERIAL PRIMARY KEY,
  TAG_NAME  VARCHAR(50) UNIQUE NOT NULL
);

-- DB_PROBLEM_TAG table
CREATE TABLE DB_PROBLEM_TAG (
  PROBLEM_ID INTEGER NOT NULL,
  TAG_ID     INTEGER NOT NULL,
  CONSTRAINT PK_PROBLEM_TAG PRIMARY KEY (PROBLEM_ID, TAG_ID),
  CONSTRAINT FK_PT_PROB FOREIGN KEY (PROBLEM_ID) REFERENCES DB_PROBLEM(PROBLEM_ID),
  CONSTRAINT FK_PT_TAG FOREIGN KEY (TAG_ID) REFERENCES DB_TAG(TAG_ID)
);

-- Drop analytics tables
DROP TABLE IF EXISTS BOUNCE_METRICS_DAILY CASCADE;
DROP TABLE IF EXISTS SESSION_METRICS_DAILY CASCADE;
DROP TABLE IF EXISTS SESSION_METRICS_DETAIL CASCADE;
DROP TABLE IF EXISTS PRODUCT_METRICS_DAILY CASCADE;
DROP TABLE IF EXISTS RAW_EVENTS CASCADE;
DROP TABLE IF EXISTS CART_ITEMS CASCADE;

-- RAW_EVENTS table
CREATE TABLE RAW_EVENTS (
  EVENT_ID           VARCHAR(50) PRIMARY KEY,
  MEMBER_ID          VARCHAR(30),
  SESSION_ID         VARCHAR(50),
  EVENT_TYPE         VARCHAR(30),
  PAGE_URL           VARCHAR(200),
  PRODUCT_ID         VARCHAR(10),
  TS_ORIG            VARCHAR(40),
  EVENT_TS           TIMESTAMP,
  EVENT_DATE         DATE,
  IS_PRODUCT_ACTION  CHAR(1),
  DETAILS_STR        TEXT,
  SEARCH_KEYWORD     VARCHAR(400),
  SELECTED_CATEGORY  VARCHAR(400),
  SORT_OPTION        VARCHAR(100),
  AS_MESSAGE         VARCHAR(2000)
);

COMMENT ON TABLE RAW_EVENTS IS '웹/앱 사용자 행동 로그 (ETL로 적재된 원시 이벤트; 전처리 후)';
COMMENT ON COLUMN RAW_EVENTS.EVENT_ID IS '원시 로그 고유 ID, 중복 방지 키';
COMMENT ON COLUMN RAW_EVENTS.SESSION_ID IS '로그인~로그아웃 세션 식별자';
COMMENT ON COLUMN RAW_EVENTS.EVENT_TYPE IS '행동 유형 (login, view_product, purchase 등)';
COMMENT ON COLUMN RAW_EVENTS.PAGE_URL IS '행동이 일어난 페이지 (/products 등)';
COMMENT ON COLUMN RAW_EVENTS.PRODUCT_ID IS '상품 관련 이벤트일 경우 대상 상품';
COMMENT ON COLUMN RAW_EVENTS.TS_ORIG IS '수집 당시 ts 문자열(원본 보존)';
COMMENT ON COLUMN RAW_EVENTS.EVENT_TS IS '파싱된 타임스탬프 (UTC 기준 등)';
COMMENT ON COLUMN RAW_EVENTS.EVENT_DATE IS 'TRUNC(EVENT_TS), 일 단위 분석용';
COMMENT ON COLUMN RAW_EVENTS.IS_PRODUCT_ACTION IS '상품관심/구매/리뷰/AS 등 상품 맥락 여부 Y/N';
COMMENT ON COLUMN RAW_EVENTS.DETAILS_STR IS '검색어/필터/정렬/AS요청 등의 원본 details JSON';
COMMENT ON COLUMN RAW_EVENTS.SEARCH_KEYWORD IS '검색어 등 텍스트 인텐트';
COMMENT ON COLUMN RAW_EVENTS.SELECTED_CATEGORY IS '선택한 카테고리 필터';
COMMENT ON COLUMN RAW_EVENTS.SORT_OPTION IS '정렬 기준 (price_asc 등)';
COMMENT ON COLUMN RAW_EVENTS.AS_MESSAGE IS 'AS 요청 본문, 불만/고장 내용';

-- Indexes for performance
CREATE INDEX IDX_RAW_EVENTS_DATE ON RAW_EVENTS (EVENT_DATE);
CREATE INDEX IDX_RAW_EVENTS_PROD ON RAW_EVENTS (PRODUCT_ID);
CREATE INDEX IDX_RAW_EVENTS_TYPE ON RAW_EVENTS (EVENT_TYPE);

-- PRODUCT_METRICS_DAILY table
CREATE TABLE PRODUCT_METRICS_DAILY (
  METRIC_DATE          DATE,
  PRODUCT_ID           VARCHAR(10),
  VIEW_COUNT           INTEGER,
  ADD_TO_CART_COUNT    INTEGER,
  PURCHASE_COUNT       INTEGER,
  REVIEW_COUNT         INTEGER,
  AS_REQUEST_COUNT     INTEGER,
  CONVERSION_RATE      NUMERIC(10,4),
  CONSTRAINT PK_PRODUCT_METRICS_DAILY PRIMARY KEY (METRIC_DATE, PRODUCT_ID)
);

COMMENT ON TABLE PRODUCT_METRICS_DAILY IS '일자별 상품 관심/구매/불만 KPI 마트 (뷰/장바구니/구매/리뷰/AS요청/전환율).';
COMMENT ON COLUMN PRODUCT_METRICS_DAILY.METRIC_DATE IS '일자';
COMMENT ON COLUMN PRODUCT_METRICS_DAILY.VIEW_COUNT IS '해당 상품 상세를 본 횟수(view_product)';
COMMENT ON COLUMN PRODUCT_METRICS_DAILY.ADD_TO_CART_COUNT IS '장바구니 담기 횟수(add_to_cart)';
COMMENT ON COLUMN PRODUCT_METRICS_DAILY.PURCHASE_COUNT IS '구매 횟수(purchase)';
COMMENT ON COLUMN PRODUCT_METRICS_DAILY.REVIEW_COUNT IS '리뷰 작성(write_review)';
COMMENT ON COLUMN PRODUCT_METRICS_DAILY.AS_REQUEST_COUNT IS 'AS 요청(as_request)';
COMMENT ON COLUMN PRODUCT_METRICS_DAILY.CONVERSION_RATE IS '구매수 / 조회수';

-- SESSION_METRICS_DETAIL table
CREATE TABLE SESSION_METRICS_DETAIL (
  METRIC_DATE           DATE,
  SESSION_ID            VARCHAR(50),
  MEMBER_ID             VARCHAR(30),
  SESSION_START_TS      TIMESTAMP,
  SESSION_END_TS        TIMESTAMP,
  SESSION_DURATION_SEC  NUMERIC,
  EVENT_COUNT           INTEGER,
  CONSTRAINT PK_SESSION_METRICS_DETAIL PRIMARY KEY (METRIC_DATE, SESSION_ID)
);

COMMENT ON TABLE SESSION_METRICS_DETAIL IS '일자 x 세션별 체류 정보 (세션 시작/끝, 체류시간, 이벤트수).';
COMMENT ON COLUMN SESSION_METRICS_DETAIL.SESSION_DURATION_SEC IS '초 단위 체류 시간 (END - START).';

-- SESSION_METRICS_DAILY table
CREATE TABLE SESSION_METRICS_DAILY (
  METRIC_DATE             DATE PRIMARY KEY,
  AVG_SESSION_SEC         NUMERIC,
  AVG_EVENT_PER_SESSION   NUMERIC,
  SESSION_COUNT           INTEGER
);

COMMENT ON TABLE SESSION_METRICS_DAILY IS '일자별 세션 품질 요약 (평균 세션 체류시간, 세션당 이벤트 수, 세션 수).';

-- BOUNCE_METRICS_DAILY table
CREATE TABLE BOUNCE_METRICS_DAILY (
  METRIC_DATE        DATE,
  LANDING_PAGE       VARCHAR(200),
  LANDING_SESSIONS   INTEGER,
  BOUNCED_SESSIONS   INTEGER,
  BOUNCE_RATE        NUMERIC(10,4),
  CONSTRAINT PK_BOUNCE_METRICS_DAILY PRIMARY KEY (METRIC_DATE, LANDING_PAGE)
);

COMMENT ON TABLE BOUNCE_METRICS_DAILY IS '일자별 랜딩 페이지 이탈율 (상품 상세 클릭 없이 떠난 세션 비율).';

-- CART_ITEMS table
CREATE TABLE CART_ITEMS (
  CART_ID       SERIAL PRIMARY KEY,
  MEMBER_ID     VARCHAR(30) NOT NULL,
  PRODUCT_ID    VARCHAR(10) NOT NULL,
  ADDED_AT      TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

COMMENT ON TABLE CART_ITEMS IS '사용자가 장바구니에 담은 상품 내역(즉시 구매 안 했어도 관심 표현)';
COMMENT ON COLUMN CART_ITEMS.CART_ID IS '장바구니PK';
COMMENT ON COLUMN CART_ITEMS.MEMBER_ID IS '사용자 ID';
COMMENT ON COLUMN CART_ITEMS.PRODUCT_ID IS '상품 ID';
COMMENT ON COLUMN CART_ITEMS.ADDED_AT IS '담은 시각';

-- Sequences (PostgreSQL SERIAL handles most auto-increment, but creating explicit sequences for specific start values)
DROP SEQUENCE IF EXISTS SEQ_CART_ITEMS;
DROP SEQUENCE IF EXISTS SEQ_PRODUCT_REVIEW;
DROP SEQUENCE IF EXISTS SEQ_AS_REQUEST;

CREATE SEQUENCE SEQ_CART_ITEMS START WITH 1 INCREMENT BY 1;
CREATE SEQUENCE SEQ_PRODUCT_REVIEW START WITH 2600 INCREMENT BY 1;
CREATE SEQUENCE SEQ_AS_REQUEST START WITH 30 INCREMENT BY 1;

-- Note: To use these sequences with SERIAL columns, you would need to alter the sequence ownership:
-- ALTER SEQUENCE SEQ_PRODUCT_REVIEW OWNED BY PRODUCT_REVIEW.REVIEW_ID;
-- ALTER SEQUENCE SEQ_AS_REQUEST OWNED BY AS_REQUEST.REQUEST_ID;
-- And set the next value:
-- SELECT setval('product_review_review_id_seq', 2600);
-- SELECT setval('as_request_request_id_seq', 30);